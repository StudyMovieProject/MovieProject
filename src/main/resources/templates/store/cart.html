<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>장바구니</title>
    <style>
        .cart-container {
            width: 80%;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
        }
        .cart-item {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }
        .item-image {
            width: 150px;
            height: 150px;
            margin-right: 20px;
        }
        .item-details {
            flex-grow: 1;
        }
        .item-details p {
            margin: 5px 0;
        }
        #main-content {
            flex: 1;
        }
        .total-price {
            font-weight: bold;
            margin-top: 20px;
        }

        .item-details {
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    max-width: 600px;
    margin: 10px auto;
    font-family: 'Arial', sans-serif;
}

.item-details h3.item-name {
    font-size: 24px;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
}

.item-details p {
    font-size: 16px;
    color: #555;
    margin-bottom: 8px;
}

.item-details p span {
    font-weight: bold;
    color: #333;
}

.item-details .item-price,
.item-details .item-sale-price {
    color: #e74c3c; /* Red color for prices */
}

.item-details .final-price {
    font-size: 18px;
    font-weight: bold;
    color: #27ae60; /* Green color for final price */
    margin-top: 15px;
}

/* Add hover effect on item name */
.item-details h3.item-name:hover {
    text-decoration: underline;
    cursor: pointer;
}
    </style>
    <script type="text/javascript">
        let selectedItems = [];  // 선택된 상품들
        let totalPrice = 0;      // 총 가격

        // 상품 선택 변경 시
        function updateTotalPrice() {
            selectedItems = [];
            totalPrice = 0;

            // 모든 체크박스를 확인하여 선택된 상품과 가격을 가져옴
            document.querySelectorAll('.item-checkbox').forEach((checkbox) => {
            console.log(checkbox.dataset);
                if (checkbox.checked) {
                    const itemCode = checkbox.value;
                    const itemPrice = parseFloat(checkbox.dataset.price);  // 가격을 숫자로 변환
                    const salePrice = checkbox.dataset.saleprice ? parseInt(checkbox.dataset.saleprice) : 0;
                    const quantity = parseInt(checkbox.dataset.quantity); // 수량을 정수로 변환
                    const cartCode = checkbox.dataset.cartcode;  // cartCode는 data-cartCode 속성으로 저장
                    console.log(cartCode);


                    // 최종 가격 계산 (가격 - 할인 가격) * 수량
                    const finalPrice = (itemPrice - salePrice) * quantity;

                    selectedItems.push(cartCode);
                    console.log(selectedItems);
                    totalPrice += finalPrice;  // 가격 합산
                }
            });

            // 총 가격을 페이지에 표시
            document.getElementById('totalPrice').textContent = totalPrice.toLocaleString() + ' 원';

            // 숨겨진 input 필드에 값을 설정
            document.getElementById('selectedItemsInput').value = JSON.stringify(selectedItems);


            // 선택된 상품이 있으면 '구매하기' 버튼을 표시
            if (selectedItems.length > 0) {
                document.getElementById('buyNowButton').style.display = 'block';
            } else {
                document.getElementById('buyNowButton').style.display = 'none';
            }
        }
    </script>
</head>
<body>

<!-- Include Header -->
<div th:insert="~{fragments/header}"></div>

<!-- Item Detail Section -->
<div id="main-content" class="container">
    <h1>장바구니</h1>

    <!-- Check if cartData is not null or empty -->
    <div th:if="${cartData != null}">
        <form id="cart-form" th:action="@{/page/pay}" method="post">
            <div th:each="cart : ${cartData}" class="cart-item">
                <img th:src="@{${cart.item.itemImage}}" alt="상품 이미지" class="item-image"/>
                <div class="item-details">
                    <h3 th:text="${cart.item.itemName}"></h3>
                    <p>장바구니번호: <span th:text="${cart.cartCode}"></span></p>
                    <p>상품 유형: <span th:text="${cart.item.itemType}"></span></p>
                    <p>상세 정보: <span th:text="${cart.item.itemDetail}"></span></p>
                    <p>사용 가능 장소: <span th:text="${cart.item.place}"></span></p>
                    <p>유효 기간: <span th:text="${cart.item.exp}"></span></p>
                    <p>가격: <span th:text="${cart.item.price} + ' 원'"></span></p>
                    <p>할인 가격: <span th:text="${cart.item.salePrice} + ' 원'"></span></p>
                    <p>수량: <span th:text="${cart.cartQty}"></span></p>
                    <p>추가 날짜: <span th:text="${cart.cartDate}"></span></p>
                    <p>최종 가격: <span th:text="${(cart.item.price - cart.item.salePrice) * cart.cartQty} + ' 원'"></span></p>

                    <!-- Toggle Button for Selection -->
                    <label>
                        <input type="checkbox" th:name="'selectedItems'" th:value="${cart.item.itemCode}"
                               th:data-price="${cart.item.price}" th:data-salePrice="${cart.item.salePrice}"
                               th:data-quantity="${cart.cartQty}" th:data-cartCode="${cart.cartCode}"
                               class="item-checkbox" onclick="updateTotalPrice()"/>
                    </label>
                </div>
            </div>

            <!-- Total Price Calculation -->
            <div class="total-price">
                <p>선택된 상품의 총 합계: <span id="totalPrice">0</span></p>
            </div>

            <!-- Buy Now Button -->
            <button type="submit" form="cart-form" id="buyNowButton" style="display:none;">구매하기</button>


            <!-- Sending selected cartCodes and total price -->
            <input type="hidden" name="selectedItems" id="selectedItemsInput"/>

        </form>
    </div>

    <!-- If cartData is null or empty -->
    <div th:if="${cartData == null}">
        <p>장바구니가 비어 있습니다.</p>
    </div>
</div>

<!-- Include Footer -->
<div th:insert="~{fragments/footer}"></div>

</body>
</html>
